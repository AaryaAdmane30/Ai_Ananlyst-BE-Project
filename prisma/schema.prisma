// 1. Prisma Client Generator
generator client {
  provider = "prisma-client-js"
}

// 2. Database Connection
datasource db {
  provider = "postgresql"
}

// 3. User Role Enum 
enum Role {
  ADMIN
  MANAGER
  DEVELOPER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

enum AiStatus {
  PROPOSED
  APPROVED
  REJECTED
  ARCHIVED
}

// 4. User Model (Base Authentication Entity)
model User {
  id       String @id @default(uuid()) // Primary key
  name     String // Full name
  email    String @unique // Login email
  password String // Hashed password
  role     Role // ADMIN / MANAGER / DEVELOPER

  companyName String? // Optional company info
  contactInfo String? // Phone or other contact

  createdAt DateTime @default(now()) // Record creation time
  updatedAt DateTime @updatedAt // Auto-update on change

  projects Project[] // Projects owned by user

  notifications Notification[]
}

// 5. Project Model (Top-level Work Container)
model Project {
  id          String  @id @default(uuid()) // Project ID
  name        String // Project name
  description String? // Optional description

  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  epics Epic[] // Project epics
  tasks Task[] // Direct project tasks
  ais   Ai[] // AI analysis records

  risks Risk[] // Identified risks
  costs Cost[] // Cost tracking
}

// 6. Epic Model (Task Grouping)
model Epic {
  id          String  @id @default(uuid()) // Epic ID
  title       String // Epic title
  description String? // Epic details

  projectId String // Linked project
  project   Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks        Task[] // Tasks under epic
  risks        Risk[] // Epic-level risks
  costs        Cost[] // Epic-level costs
  workflowRuns WorkflowRun[]
}

// 7. Team Member Model (People Working Under Manager)
model TeamMember {
  id    String  @id @default(uuid()) // Team member ID
  name  String? // <-- made optional temporarily
  email String? // <-- made optional temporarily
  role  Role // Role in system

  managerId String? // Manager reference

  createdAt DateTime @default(now())
}

// 8. Task Model (Atomic Work Unit)
model Task {
  id          String     @id @default(uuid()) // Task ID
  title       String // Task title
  description String? // Task details
  status      TaskStatus @default(TODO) // Task state

  projectId String? // <-- made optional temporarily
  epicId    String? // Optional epic reference

  project Project? @relation(fields: [projectId], references: [id])
  epic    Epic?    @relation(fields: [epicId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  risks Risk[] // Task risks
  costs Cost[] // Task costs
}

// 9. AI Model (AI-Generated Suggestions)
model Ai {
  id                 String  @id @default(uuid()) // AI record ID
  laborCost          Float? // Estimated labor cost
  reworkCost         Float? // Estimated rework cost
  infrastructureCost Float? // Infra cost
  totalSavings       Float? // Predicted savings
  description        String? // AI explanation

  projectId String // Linked project
  project   Project @relation(fields: [projectId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt // <-- made optional temporarily

  risks      Risk[] // AI-detected risks
  costs      Cost[] // AI cost estimates
  aiFeedback AiFeedback[] // AI cost estimates
}

// 10. Risk Model (Issues & Threats)
model Risk {
  id          String  @id @default(uuid()) // Risk ID
  type        String // Risk type
  severity    String  @default("MEDIUM") // LOW / MEDIUM / HIGH
  description String? // Risk explanation
  mitigation  String? // How to reduce risk
  resolved    Boolean @default(false) // Status flag

  taskId    String? // Optional task link
  epicId    String? // Optional epic link
  projectId String? // Optional project link
  aiId      String? // Optional AI link

  task    Task?    @relation(fields: [taskId], references: [id])
  epic    Epic?    @relation(fields: [epicId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  ai      Ai?      @relation(fields: [aiId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 11. Cost Model (Financial Tracking)
model Cost {
  id                 String  @id @default(uuid()) // Cost ID
  laborCost          Float?  @default(0) // Labor expenses
  reworkCost         Float?  @default(0) // Rework expenses
  infrastructureCost Float?  @default(0) // Infra expenses
  otherCost          Float?  @default(0) // Misc expenses
  totalCost          Float? // Final cost
  savings            Float?  @default(0) // Savings achieved
  description        String? // Notes

  taskId    String? // Linked task
  epicId    String? // Linked epic
  projectId String? // Linked project
  aiId      String? // Linked AI

  task    Task?    @relation(fields: [taskId], references: [id])
  epic    Epic?    @relation(fields: [epicId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  ai      Ai?      @relation(fields: [aiId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 11. AI FEEDBACK
model AiFeedback {
  id        String   @id @default(uuid())
  aiId      String
  approved  Boolean?
  comment   String?
  createdAt DateTime @default(now())

  ai Ai @relation(fields: [aiId], references: [id])
}

// 12. WORKFLOW RUN (Orchestrator logs)
model WorkflowRun {
  id         String    @id @default(uuid())
  epicId     String // required, because every workflow run must belong to an epic
  status     String    @default("PENDING") // PENDING / RUNNING / COMPLETED / FAILED
  logs       Json?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  epic Epic @relation(fields: [epicId], references: [id])
}

// 13. NOTIFICATION (For manager alerts)
model Notification {
  id        String   @id @default(uuid())
  userId    String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// 17. AGENT METADATA
model Agent {
  id          String   @id @default(uuid())
  name        String // ResumeAgent, AssignmentAgent, etc
  version     String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
